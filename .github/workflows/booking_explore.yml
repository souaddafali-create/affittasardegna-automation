name: Booking.com - Esplora il sito reale

on:
  workflow_dispatch:

jobs:
  esplora:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: '3.12'

      - name: Installa dipendenze
        run: pip install playwright beautifulsoup4

      - name: Installa Chromium
        run: python -m playwright install --with-deps chromium

      - name: Esplora Booking.com
        env:
          BK_EMAIL: ${{ secrets.BK_EMAIL }}
          BK_PASSWORD: ${{ secrets.BK_PASSWORD }}
        run: |
          xvfb-run --auto-servernum python3 -c "
          import os, time
          from playwright.sync_api import sync_playwright

          email = os.environ.get('BK_EMAIL', '')
          password = os.environ.get('BK_PASSWORD', '')

          if not email or 'tua' in email:
              print('ERRORE: BK_EMAIL non configurato')
              exit(1)

          print(f'Username: {email[:3]}***')

          with sync_playwright() as pw:
              browser = pw.chromium.launch(headless=True, args=['--no-sandbox', '--disable-dev-shm-usage'])
              context = browser.new_context(locale='it-IT', viewport={'width':1280,'height':900})
              page = context.new_page()

              try:
                  print('Step 1: Apro login Extranet Booking...')
                  page.goto('https://admin.booking.com', timeout=30000)
                  time.sleep(3)
                  page.screenshot(path='step01_login.png')
                  print('  Screenshot: step01_login.png')
                  with open('step01_login.html', 'w') as f:
                      f.write(page.content())

                  print('Step 2: Cerco campo username/email...')
                  try:
                      page.fill('input[type=\"email\"], input[name=\"loginname\"], input[name=\"username\"], input[id=\"loginname\"], input[type=\"text\"]', email, timeout=10000)
                      page.screenshot(path='step02_username.png')
                      print('  Username inserito')
                  except Exception as e:
                      print(f'  Errore username: {e}')
                      page.screenshot(path='step02_errore.png')

                  print('Step 3: Click continua/submit...')
                  try:
                      page.click('button[type=\"submit\"], input[type=\"submit\"], button:has-text(\"Continue\"), button:has-text(\"Continua\"), button:has-text(\"Sign in\"), button:has-text(\"Accedi\")', timeout=10000)
                      time.sleep(3)
                      page.screenshot(path='step03_dopo_username.png')
                      print('  Click fatto')
                      with open('step03_pagina.html', 'w') as f:
                          f.write(page.content())
                  except Exception as e:
                      print(f'  Errore click: {e}')
                      page.screenshot(path='step03_errore.png')

                  print('Step 4: Cerco campo password...')
                  time.sleep(2)
                  page.screenshot(path='step04_password_pagina.png')
                  with open('step04_pagina.html', 'w') as f:
                      f.write(page.content())

                  try:
                      page.fill('input[type=\"password\"], input[name=\"password\"], input[id=\"password\"]', password, timeout=10000)
                      page.screenshot(path='step05_password.png')
                      print('  Password inserita')
                      page.click('button[type=\"submit\"], input[type=\"submit\"], button:has-text(\"Sign in\"), button:has-text(\"Accedi\")', timeout=10000)
                      time.sleep(5)
                      page.screenshot(path='step06_dopo_login.png')
                      print('  Login completato')
                      with open('step06_pagina.html', 'w') as f:
                          f.write(page.content())
                  except Exception as e:
                      print(f'  Errore password/login: {e}')
                      page.screenshot(path='step05_errore.png')

                  print('Step 5: Verifico dove siamo...')
                  time.sleep(3)
                  page.screenshot(path='step07_stato_finale.png')
                  with open('step07_finale.html', 'w') as f:
                      f.write(page.content())
                  print(f'  URL finale: {page.url}')

              except Exception as e:
                  print(f'Errore generale: {e}')
                  page.screenshot(path='errore_generale.png')
              finally:
                  browser.close()
          print('FINE')
          "

      - name: Carica screenshot
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: booking-debug
          path: |
            *.png
            *.html
